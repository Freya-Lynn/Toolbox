<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toolbox</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1a73e8',
            'primary-hover': '#1557b0',
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: "Google Sans", "Product Sans", Arial, sans-serif; 
    }
    body[data-theme="light"] {
      background: var(--bg-page);
    }
    body[data-theme="dark"] {
      background: #202124;
    }
    .toast { animation: fadeInOut 3s ease-in-out; }
    @keyframes fadeInOut { 0% { opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; } }
    
    .btn-laser {
      background: transparent;
      border: 1.5px solid var(--highlight, #ff8ba7);
      color: var(--highlight, #ff8ba7);
      box-shadow: 0 0 8px rgba(255, 139, 167, 0.2);
    }
    .btn-laser:hover {
      background: rgba(255, 139, 167, 0.08);
      box-shadow: 0 0 12px rgba(255, 139, 167, 0.3);
    }
    body[data-theme="dark"] .btn-laser {
      border-color: #8ab4f8;
      color: #8ab4f8;
      box-shadow: 0 0 8px rgba(138, 180, 248, 0.2);
    }
    body[data-theme="dark"] .btn-laser:hover {
      background: rgba(138, 180, 248, 0.1);
      box-shadow: 0 0 12px rgba(138, 180, 248, 0.3);
    }
    
    .btn-laser-bold {
      background: transparent;
      border: 2px solid var(--highlight, #ff8ba7);
      color: var(--highlight, #ff8ba7);
      box-shadow: 0 0 8px rgba(255, 139, 167, 0.2);
    }
    .btn-laser-bold:hover {
      background: rgba(255, 139, 167, 0.08);
      box-shadow: 0 0 12px rgba(255, 139, 167, 0.3);
    }
    body[data-theme="dark"] .btn-laser-bold {
      border-color: #8ab4f8;
      color: #8ab4f8;
      box-shadow: 0 0 8px rgba(138, 180, 248, 0.2);
    }
    body[data-theme="dark"] .btn-laser-bold:hover {
      background: rgba(138, 180, 248, 0.1);
      box-shadow: 0 0 12px rgba(138, 180, 248, 0.3);
    }
    
    .btn-laser-danger {
      background: transparent;
      border: 2px solid #ea4335;
      color: #ea4335;
      box-shadow: 0 0 8px rgba(234, 67, 53, 0.2);
    }
    .btn-laser-danger:hover {
      background: rgba(234, 67, 53, 0.08);
      box-shadow: 0 0 12px rgba(234, 67, 53, 0.3);
    }
    body[data-theme="dark"] .btn-laser-danger {
      border-color: #f28b82;
      color: #f28b82;
      box-shadow: 0 0 8px rgba(242, 139, 130, 0.2);
    }
    body[data-theme="dark"] .btn-laser-danger:hover {
      background: rgba(242, 139, 130, 0.1);
      box-shadow: 0 0 12px rgba(242, 139, 130, 0.3);
    }
    
    .content-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .page-title {
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'Segoe UI Black', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, var(--highlight) 0%, var(--stroke) 50%, var(--highlight) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    body[data-theme="dark"] .page-title {
      background: linear-gradient(135deg, #8ab4f8 0%, #aecbfa 50%, #8ab4f8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(138, 180, 248, 0.4);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, var(--highlight) 0%, var(--stroke) 50%, var(--highlight) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    body[data-theme="dark"] .gradient-text {
      background: linear-gradient(135deg, #8ab4f8 0%, #aecbfa 50%, #8ab4f8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .page-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      font-family: 'Segoe UI Black', 'Segoe UI', Arial, sans-serif;
      background: #ffffff;
      border: 2px solid var(--stroke);
      color: var(--text-main);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .page-icon:hover {
      transform: scale(1.1);
    }
    body[data-theme="dark"] .page-icon {
      background: linear-gradient(135deg, rgba(138, 180, 248, 0.12) 0%, rgba(174, 203, 250, 0.06) 100%);
      border: 2px solid rgba(138, 180, 248, 0.4);
      color: #8ab4f8;
      text-shadow: 0 0 12px rgba(138, 180, 248, 0.5);
    }
    
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: transparent;
      border: 1px solid var(--highlight);
      border-radius: 12px;
      font-size: 11px;
      color: var(--highlight);
    }
    body[data-theme="dark"] .tag-chip {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: rgba(255, 255, 255, 0.8);
    }
    body[data-theme="dark"] .note-tag {
      background: transparent;
      border: 1px dashed rgba(255, 255, 255, 0.5);
      color: #ffffff;
    }
    
    .note-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: transparent;
      border: 1px dashed var(--stroke);
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-main);
    }
    body[data-theme="dark"] .note-tag {
      background: transparent;
      border: 1px dashed rgba(255, 255, 255, 0.5);
      color: #ffffff;
    }
    .note-tag button {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: var(--text-main);
    }
    body[data-theme="dark"] .note-tag button {
      color: #ffffff;
    }
    .note-tag button:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    body[data-theme="dark"] .note-tag button:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Light theme overrides */
    body[data-theme="light"] #app { 
      --stroke: #33272a;
      --main: #ffffff;
      --sidebar-bg: #ffc6c7;
      --highlight: #ff8ba7;
      --secondary: #ffc6c7;
      --tertiary: #c3f0ca;
      --text-main: #33272a;
      --text-light: #5a4e50;
      --border-main: #140507d9;
      --border-sub: #dee2e8;
      --border-color: #5D4037; 
      --text-primary: #33272a; 
      --text-secondary: #5a4e50; 
      --card-bg: #ffffff; 
    }
    body[data-theme="light"] {
      background: var(--bg-page);
    }
    body[data-theme="dark"] #app { --sidebar-bg: #1a237e; --main-bg: #000000; --border-color: rgba(138, 180, 248, 0.4); --border-main: rgba(138, 180, 248, 0.4); --text-primary: #ffffff; --text-secondary: #cccccc; --text-main: #ffffff; --card-bg: #000000; }
    body[data-theme="dark"] #sidebar { 
      border-color: rgba(138, 180, 248, 0.4) !important; 
      background: 
        radial-gradient(ellipse at top left, rgba(255,255,255,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(255,255,255,0.05) 0%, transparent 50%),
        linear-gradient(135deg, #101840 0%, #0d1428 100%) !important;
    }
    body[data-theme="dark"] #tagFilterArea { 
      background: 
        radial-gradient(ellipse at top left, rgba(255,255,255,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(255,255,255,0.05) 0%, transparent 50%),
        linear-gradient(135deg, #101840 0%, #0d1428 100%) !important;
      border-color: rgba(138, 180, 248, 0.4) !important;
    }
    body[data-theme="dark"] main.flex-1 { 
      background: 
        radial-gradient(ellipse at top left, rgba(255,255,255,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(255,255,255,0.05) 0%, transparent 50%),
        linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%) !important;
      border-color: rgba(138, 180, 248, 0.4) !important;
    }
    body[data-theme="dark"] { background: #000000; }
    
    .theme-btn {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
    }
    body[data-theme="light"] .theme-btn {
      border: 2px solid var(--highlight);
    }
    body[data-theme="dark"] .theme-btn {
      border: 2px solid #8ab4f8;
    }
    
    .toggle-text { color: var(--text-secondary); }
    body[data-theme="light"] .toggle-text:hover { color: var(--highlight); }
    body[data-theme="dark"] .toggle-text:hover { color: #ffffff; }
    body[data-theme="light"] .hover\:bg-blue-100:hover { background: #e8f0fe; }
    .toggle-bg { background: var(--main-bg); border-color: var(--border-color); }
    .toggle-bg-alt { background: var(--sidebar-bg); border-color: var(--border-color); }
    .toggle-card { background: var(--card-bg); border-color: var(--border-color); color: var(--text-primary); }
    .toggle-input { background: var(--sidebar-bg); border-color: var(--border-color); color: var(--text-primary); }
    
    .modal-input {
      background: #ffffff;
      border: 1px solid #cccccc;
      color: #333333;
    }
    body[data-theme="dark"] .modal-input {
      background: #292a2d;
      border: 1px solid #555555;
      color: #e8eaed;
    }
    body[data-theme="dark"] .modal-input::placeholder {
      color: #9aa0a6;
    }
    body[data-theme="dark"] .modal-input:focus {
      border-color: #8ab4f8;
    }
    
    .color-scheme-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #140507d9;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .color-scheme-btn:hover { transform: scale(1.1); }
    .color-scheme-btn.active { border-color: var(--stroke); transform: scale(1.1); }
    .hover-tertiary:hover { background: var(--tertiary) !important; }
    
    .folder-item:hover .folder-edit-btn { opacity: 1 !important; }
    .folder-icon { width: 16px; text-align: center; }
    
    .animal-option { background: transparent; }
    body[data-theme="light"] .animal-option.selected { background: var(--tertiary); }
    body[data-theme="dark"] .animal-option.selected { background: rgba(138, 180, 248, 0.2); }
    .global-search-box { background: var(--sidebar-bg); }
    .global-search-box span,
    .global-search-box input { color: var(--text-secondary); }
    body[data-theme="dark"] .global-search-box { background: #ffffff; border: 1px solid rgba(138, 180, 248, 0.4); }
    body[data-theme="dark"] .global-search-box span { color: #333333 !important; }
    body[data-theme="dark"] .global-search-box input { color: #333333 !important; }
  </style>
</head>
<body data-theme="light" class="h-screen overflow-hidden">
  <div id="app" class="flex h-full p-4">
    <!-- Left Sidebar -->
    <aside id="sidebar" class="w-[240px] flex flex-col border-[3px] flex-shrink-0 rounded-2xl overflow-hidden"
           style="background: var(--sidebar-bg); border-color: var(--border-main);">
      <div class="p-4 border-b-2" style="border-color: var(--border-main);">
        <div class="flex items-center gap-2">
          <div id="animalIcon" class="page-icon cursor-pointer" onclick="showAnimalSelector()" title="ç‚¹å‡»åˆ‡æ¢å¤´åƒ">ğŸ±</div>
          <h1 class="page-title">Toolbox</h1>
        </div>
      </div>
      <nav id="categoryList" class="flex-1 overflow-y-auto p-2 space-y-1"></nav>
      <div class="p-3 border-t-2" style="border-color: var(--border-main);">
        <button onclick="showCategoryModal(false)" class="w-full py-2 px-3 text-sm font-bold rounded transition text-left toggle-text hover-tertiary">+ New Page</button>
      </div>
      <div class="p-3 border-t-2 space-y-2" style="border-color: var(--border-main);">
        <button onclick="exportData()" class="w-full py-2 px-3 text-sm font-bold rounded transition text-left toggle-text hover-tertiary">Export Data</button>
        <button onclick="importData()" class="w-full py-2 px-3 text-sm font-bold rounded transition text-left toggle-text hover-tertiary">Import Data</button>
        <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(event)">
      </div>
      <div class="p-3 border-t-2 color-scheme-section" style="border-color: var(--border-main);">
        <p class="text-xs font-bold mb-2 toggle-text">Color Scheme</p>
        <div class="flex gap-2" id="colorSchemeList"></div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden border-[3px] rounded-2xl overflow-hidden shadow-sm ml-4"
          style="background: var(--main-bg); border-color: var(--border-main);">
      <!-- Header with border -->
      <header class="px-6 py-4 flex items-center justify-between flex-shrink-0"
              style="background: var(--main-bg); border-bottom: 2px solid var(--border-main);">
        <div class="flex items-center gap-4">
          <h2 id="currentCategoryName" class="page-title"></h2>
          <button onclick="editCategory()" class="btn-laser px-2 py-1 rounded text-xs font-bold transition border-2" style="color: var(--highlight);">Rename</button>
          <button onclick="deleteCategory()" class="btn-laser-danger px-2 py-1 rounded text-xs font-bold transition border-2">Delete</button>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-1 px-2 py-1 rounded global-search-box">
            <span class="text-sm">ğŸ”</span>
            <input type="text" id="globalSearch" onkeyup="handleGlobalSearch(this.value)" placeholder="Global search..." class="bg-transparent border-none outline-none text-sm" style="width: 120px;">
            <span onclick="clearGlobalSearch()" class="cursor-pointer text-xs">Ã—</span>
          </div>
          <button onclick="toggleTheme()" class="theme-btn" title="Toggle theme">ğŸŒ™</button>
          <button onclick="showSubCompartmentModal()" class="btn-laser-bold px-4 py-2 rounded text-sm font-bold transition">+ New Group</button>
        </div>
      </header>

      <!-- Group Tabs -->
      <div class="px-6 py-3 flex items-center justify-between flex-shrink-0 toggle-bg border-b">
        <div id="subTagList" class="flex flex-wrap gap-2"></div>
        <div class="flex gap-2">
          <button onclick="showWebItemModal()" class="btn-laser px-3 py-1 rounded text-sm font-medium transition">+ Web</button>
          <button onclick="showAppItemModal()" class="btn-laser px-3 py-1 rounded text-sm font-medium transition">+ App</button>
        </div>
      </div>

      <!-- Tag Filter Area -->
      <div id="tagFilterArea" class="px-6 py-2 flex items-center justify-between flex-shrink-0 toggle-bg-alt border-b">
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">Tag:</span>
          <div id="tagFilterList" class="flex flex-wrap gap-1"></div>
          <button id="clearTagFilter" onclick="clearTagFilter()" class="text-xs toggle-text hover:text-red-500 hidden">Ã— Clear</button>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-1 px-2 py-1 rounded bg-white border">
            <span class="text-sm text-gray-500">ğŸ”</span>
            <input type="text" id="localSearch" onkeyup="handleLocalSearch(this.value)" placeholder="Search..." class="bg-transparent border-none outline-none text-sm text-gray-700" style="width: 100px;">
            <span onclick="clearLocalSearch()" class="cursor-pointer text-xs text-gray-500">Ã—</span>
          </div>
          <span class="text-xs text-gray-500">Filter:</span>
          <div class="flex gap-1">
            <button onclick="changeSort('name-asc')" class="sort-btn px-2 py-1 rounded text-xs bg-gray-200 text-gray-700" data-sort="name-asc" title="Sort A-Z">Aâ†’Z</button>
            <button onclick="changeSort('name-desc')" class="sort-btn px-2 py-1 rounded text-xs bg-gray-200 text-gray-700" data-sort="name-desc" title="Sort Z-A">Zâ†’A</button>
            <button onclick="changeSort('created')" class="sort-btn px-2 py-1 rounded text-xs bg-gray-200 text-gray-700" data-sort="created" title="Sort by creation time">ğŸ•</button>
          </div>
        </div>
      </div>

        <!-- Content Area -->
      <div class="flex-1 overflow-y-auto p-4" style="background: var(--main-bg);">
        <div id="contentGrid" class="flex flex-wrap gap-2.5"></div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
    <div class="bg-[#303134] rounded-lg w-[460px] max-w-[90vw] shadow-xl border border-gray-600">
      <div class="px-6 py-4 border-b border-gray-600">
        <h3 id="modalTitle" class="text-lg font-medium text-gray-200"></h3>
      </div>
      <div id="modalContent" class="p-6"></div>
      <div id="modalActions" class="px-6 py-3 bg-[#292a2d] flex justify-end gap-2 rounded-b-lg"></div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmOverlay" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
    <div class="bg-[#303134] rounded-lg w-[360px] max-w-[90vw] shadow-xl border border-gray-600">
      <div class="px-6 py-4 border-b border-gray-600">
        <h3 class="text-lg font-medium text-gray-200">Confirm</h3>
      </div>
      <div class="px-6 py-4">
        <p id="confirmMessage" class="text-sm text-gray-400"></p>
      </div>
      <div class="px-6 py-3 bg-[#292a2d] flex justify-end gap-2 rounded-b-lg">
        <button onclick="closeConfirm()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded text-sm transition">Cancel</button>
        <button id="confirmBtn" class="btn-laser-danger px-4 py-2 rounded text-sm transition">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    var data = { folders: [], categories: [] };
    var currentFolderIndex = -1; // -1 è¡¨ç¤ºæ ¹ç›®å½•ï¼ˆæ— æ–‡ä»¶å¤¹ï¼‰
    var currentCategoryIndex = 0;
    var currentSubIndex = 0;
    var currentTagFilter = null;
    var expandedFolders = {}; // è·Ÿè¸ªå±•å¼€/æŠ˜å çŠ¶æ€
    var pageIcons = ['P', 'D', 'V', 'W', 'A', 'S', 'M', 'T'];
    var animals = ['ğŸ±', 'ğŸ¶', 'ğŸ·', 'ğŸ', 'ğŸ¦', 'ğŸ°', 'ğŸ¼', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¸'];
    var appEmojis = ['ğŸ–¥ï¸', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ“±', 'ğŸ“', 'â˜ï¸', 'ğŸ“º', 'ğŸ“·', 'ğŸ¥', 'ğŸ¤', 'ğŸ“»', 'ğŸ•¹ï¸', 'ğŸ®', 'ğŸµ', 'ğŸ§', 'ğŸ“š', 'ğŸ“–', 'ğŸ“', 'ğŸ““', 'ğŸ“’', 'ğŸ“‘', 'ğŸ“Œ', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“…', 'â°', 'â±ï¸', 'â²ï¸', 'ğŸŒ', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“¹', 'ğŸ”§', 'ğŸ”¨', 'ğŸ› ï¸', 'âš™ï¸', 'ğŸ”©', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ“¡', 'ğŸ“¶', 'ğŸ“Ÿ', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¨ï¸', 'ğŸ“§', 'ğŸ“©', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“¯', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ’©', 'ğŸš½', 'ğŸ§»', 'ğŸ§¼', 'ğŸ§½', 'ğŸ§¹', 'ğŸª£', 'ğŸ§´', 'ğŸ›€', 'ğŸ›Œ', 'ğŸ§¸', 'ğŸª†', 'ğŸ–¼ï¸', 'ğŸª', 'ğŸªŸ', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸ›ï¸', 'ğŸšª', 'ğŸ—ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ”‘', 'ğŸ§³', 'ğŸ’¼', 'ğŸ’', 'ğŸ‘', 'ğŸ‘œ', 'ğŸ‘›', 'ğŸ’°', 'ğŸ’³', 'ğŸ’µ', 'ğŸ¦', 'ğŸ§', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸ‡', 'ğŸ“', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ…', 'ğŸ¥‘', 'ğŸ”', 'ğŸ•', 'ğŸŒ­', 'ğŸŸ', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ', 'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ–ï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸', 'ğŸª', 'ğŸ­', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸª•', 'ğŸ»', 'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ¤–', 'ğŸ‘¾', 'ğŸ²', 'ğŸ¯', 'ğŸ³', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
    var currentAnimal = 'ğŸ±';
    var globalSearchQuery = '';
    var localSearchQuery = '';
    var currentSortMethod = 'name-asc';
    var colorSchemes = [
      { name: 'Berry', bg: '#faeee7', sidebar: '#ffc6c7', stroke: '#33272a', highlight: '#ff8ba7', secondary: '#ffc6c7', tertiary: '#c3f0ca', textMain: '#33272a', textLight: '#594a4e', borderMain: '#140507d9', borderSub: '#dee2e8', main: '#fffffe' },
      { name: 'Lemon', bg: '#fff9db', sidebar: '#e3f6f5', stroke: '#272343', highlight: '#ffd803', secondary: '#e3f6f5', tertiary: '#bae8e8', textMain: '#272343', textLight: '#4a4568', borderMain: '#140507d9', borderSub: '#dee2e8' },
      { name: 'Ocean', bg: '#e3f2fd', sidebar: '#a0c4de', stroke: '#094067', highlight: '#3da9fc', secondary: '#90b4ce', tertiary: '#ef4565', textMain: '#094067', textLight: '#4a6d8c', borderMain: '#140507d9', borderSub: '#dee2e8' },
      { name: 'Forest', bg: '#e8e4e6', sidebar: '#b8ddd3', stroke: '#001e1d', highlight: '#abd1c6', secondary: '#abd1c6', tertiary: '#e16162', textMain: '#001e1d', textLight: '#3d5c5a', borderMain: '#140507d9', borderSub: '#dee2e8' }
    ];
    var currentColorScheme = 0;
    var copyMoveItem = null;
    var copyMoveMode = ''; // 'copy' or 'move'
    var copyMoveSourceIndex = -1;

    function init() {
      var stored = localStorage.getItem('toolbox-data');
      if (stored) {
        try {
          var parsed = JSON.parse(stored);
          // Handle old format - migrate to new folder structure
          if (parsed.categories && Array.isArray(parsed.categories) && !parsed.folders) {
            // Old format: only categories, no folders
            // Create a default folder with all categories
            var categoryIds = parsed.categories.map(function(cat) { return cat.id; });
            data = {
              folders: [{ id: generateId(), name: 'Default', categoryIds: categoryIds }],
              categories: parsed.categories
            };
          }
          // Handle new format
          else if (parsed.folders && parsed.categories) {
            data = parsed;
          } else {
            data = getDefaultData();
          }
        } catch (e) {
          data = getDefaultData();
        }
      } else {
        data = getDefaultData();
      }
      // Ensure data has valid structure
      if (!data.folders || !Array.isArray(data.folders)) {
        data.folders = [];
      }
      if (!data.categories || !Array.isArray(data.categories)) {
        data.categories = [];
      }
      // Ensure currentFolderIndex is valid
      if (currentFolderIndex >= data.folders.length) {
        currentFolderIndex = data.folders.length > 0 ? 0 : -1;
      }
      // Initialize first category if needed
      if (data.categories.length > 0 && currentCategoryIndex >= data.categories.length) {
        currentCategoryIndex = 0;
      }
      // Initialize expanded folders state
      data.folders.forEach(function(folder) {
        if (expandedFolders[folder.id] === undefined) {
          expandedFolders[folder.id] = true; // Default expanded
        }
      });
      // Save valid data
      saveData();
      var savedTheme = localStorage.getItem('toolbox-theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      // Hide color scheme in dark mode
      var colorSection = document.querySelector('.color-scheme-section');
      if (colorSection) {
        colorSection.style.display = savedTheme === 'dark' ? 'none' : 'block';
      }
      
      // Apply frosted effect to main content in dark mode
      applyFrostedEffect(savedTheme);
      
      currentColorScheme = parseInt(localStorage.getItem('toolbox-color-scheme') || '0');
      applyColorScheme(currentColorScheme);
      renderColorSchemeSelector();
      
      // Load saved animal icon
      var savedAnimal = localStorage.getItem('toolbox-animal');
      if (savedAnimal && animals.indexOf(savedAnimal) !== -1) {
        currentAnimal = savedAnimal;
      }
      updateAnimalIcon();
      
      currentTagFilter = null;
      renderCategoryList();
      renderSubTagList();
      renderTagFilter();
      updateSortButtons();
      renderContent();
      console.log('Toolbox initialized');
    }

    function renderColorSchemeSelector() {
      var list = document.getElementById('colorSchemeList');
      if (!list) return;
      var html = '';
      for (var i = 0; i < colorSchemes.length; i++) {
        var scheme = colorSchemes[i];
        var activeClass = i === currentColorScheme ? 'active' : '';
        html += '<div onclick="selectColorScheme(' + i + ')" class="color-scheme-btn ' + activeClass + '" style="background: ' + scheme.highlight + ';" title="' + scheme.name + '"></div>';
      }
      list.innerHTML = html;
    }

    function selectColorScheme(index) {
      currentColorScheme = index;
      localStorage.setItem('toolbox-color-scheme', index);
      applyColorScheme(index);
      renderColorSchemeSelector();
      if (document.body.getAttribute('data-theme') === 'light') {
        renderCategoryList();
        renderSubTagList();
        renderTagFilter();
        renderContent();
      }
    }

    function applyColorScheme(index) {
      var scheme = colorSchemes[index];
      var app = document.getElementById('app');
      if (app) {
        app.style.setProperty('--stroke', scheme.stroke);
        app.style.setProperty('--main', scheme.main || '#ffffff');
        app.style.setProperty('--bg-page', scheme.bg);
        app.style.setProperty('--sidebar-bg', scheme.sidebar);
        app.style.setProperty('--highlight', scheme.highlight);
        app.style.setProperty('--secondary', scheme.secondary);
        app.style.setProperty('--tertiary', scheme.tertiary);
        app.style.setProperty('--text-main', scheme.textMain);
        app.style.setProperty('--text-light', scheme.textLight);
        app.style.setProperty('--border-main', scheme.borderMain || scheme.stroke);
        app.style.setProperty('--border-sub', scheme.borderSub || scheme.stroke);
      }
    }

    function toggleTheme() {
      var currentTheme = document.body.getAttribute('data-theme');
      var newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('toolbox-theme', newTheme);
      updateThemeIcon(newTheme);
      
      // Apply frosted effect to main content in dark mode
      applyFrostedEffect(newTheme);
      
      // Hide/show color scheme based on theme
      var colorSection = document.querySelector('.color-scheme-section');
      if (colorSection) {
        colorSection.style.display = newTheme === 'dark' ? 'none' : 'block';
      }
      
      if (newTheme === 'light') {
        applyColorScheme(currentColorScheme);
      }
      renderCategoryList();
      renderSubTagList();
      renderTagFilter();
      renderContent();
    }
    
    function applyFrostedEffect(theme) {
      var mainContent = document.querySelector('main.flex-1');
      if (!mainContent) return;
      
      if (theme === 'dark') {
        mainContent.style.background = 'radial-gradient(ellipse at top left, rgba(255,255,255,0.08) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(255,255,255,0.05) 0%, transparent 50%), linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%)';
      } else {
        mainContent.style.background = '';
      }
    }

    function updateThemeIcon(theme) {
      var btn = document.querySelector('.theme-btn');
      if (btn) {
        btn.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
      }
    }

    function getDefaultData() {
      var id1 = generateId();
      var id2 = generateId();
      var id3 = generateId();
      var id4 = generateId();
      return {
        folders: [
          { id: generateId(), name: 'åŠå…¬', categoryIds: [id1, id2, id3, id4] }
        ],
        categories: [
          { id: id1, name: 'PPT Tools', subCompartments: [{ id: generateId(), name: 'Resources', items: [] }, { id: generateId(), name: 'Templates', items: [] }] },
          { id: id2, name: 'Poster Design', subCompartments: [{ id: generateId(), name: 'Design Tools', items: [] }] },
          { id: id3, name: 'Video Editing', subCompartments: [{ id: generateId(), name: 'Software', items: [] }] },
          { id: id4, name: 'Writing', subCompartments: [{ id: generateId(), name: 'Writing Tools', items: [] }] }
        ]
      };
    }

    var acronyms = ['PPT', 'URL', 'API', 'HTML', 'CSS', 'PDF', 'APP', 'WEB', 'JPG', 'PNG', 'GIF', 'SVG', 'JSON', 'XML', 'HTTP', 'HTTPS', 'FTP', 'USB', 'DVD', 'CD', 'MP3', 'MP4', 'AVI', 'DOC', 'DOCX', 'XLS', 'XLSX', 'ZIP', 'RAR'];

    function capitalizeWithAcronyms(text) {
      var words = text.split(' ');
      var result = [];
      for (var i = 0; i < words.length; i++) {
        if (words[i]) {
          result.push(capitalizeWord(words[i]));
        }
      }
      return result.join(' ');
    }

    function capitalizeWord(word) {
      var upperWord = word.toUpperCase();
      for (var i = 0; i < acronyms.length; i++) {
        if (upperWord === acronyms[i]) {
          return acronyms[i];
        }
      }
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    }

    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveData() {
      localStorage.setItem('toolbox-data', JSON.stringify(data));
    }

    function updateAnimalIcon() {
      var iconEl = document.getElementById('animalIcon');
      if (iconEl) {
        iconEl.textContent = currentAnimal;
      }
    }

    function showAnimalSelector() {
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var html = '<div class="flex flex-wrap gap-2 justify-center mb-4">';
      for (var i = 0; i < animals.length; i++) {
        var isSelected = animals[i] === currentAnimal;
        var selectedStyle = isSelected ? 'background: var(--highlight);' : '';
        var selectedClass = isSelected ? 'animal-option selected' : 'animal-option';
        html += '<div onclick="selectAnimal(' + i + ')" class="' + selectedClass + ' text-2xl cursor-pointer p-2 rounded-lg transition-transform hover:scale-125" style="' + selectedStyle + '" title="' + animals[i] + '">' + animals[i] + '</div>';
      }
      html += '</div>';
      html += '<div class="text-center mb-4">';
      html += '<button onclick="randomAnimal()" class="btn-laser px-4 py-2 rounded text-sm font-bold transition">ğŸ² Random</button>';
      html += '</div>';
      
      showModal('é€‰æ‹©å¤´åƒ / Select Animal', html, [
        { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' }
      ]);
    }

    function selectAnimal(index) {
      currentAnimal = animals[index];
      localStorage.setItem('toolbox-animal', currentAnimal);
      updateAnimalIcon();
      closeModal();
    }

    function randomAnimal() {
      var randomIndex = Math.floor(Math.random() * animals.length);
      currentAnimal = animals[randomIndex];
      localStorage.setItem('toolbox-animal', currentAnimal);
      updateAnimalIcon();
      closeModal();
      showToast('éšæœºåˆ‡æ¢: ' + currentAnimal);
    }

    var currentEmojiMode = 'image';
    var selectedEmoji = null;
    var selectedEmojiBg = '#E8B4B8'; // 'image' or 'emoji'

    var emojiCategories = [
      { name: 'Tech & Office', emojis: ['ğŸ–¥ï¸', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ“±', 'ğŸ“', 'â˜ï¸', 'ğŸ“º', 'ğŸ“·', 'ğŸ¥', 'ğŸ¤', 'ğŸ“»', 'ğŸ•¹ï¸', 'ğŸ®', 'ğŸµ', 'ğŸ§', 'ğŸ“š', 'ğŸ“–', 'ğŸ“', 'ğŸ““', 'ğŸ“’', 'ğŸ“‘', 'ğŸ“Œ', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'ğŸ“', 'ğŸ“', 'ğŸ§®', 'ğŸ“…', 'â°', 'â±ï¸', 'â²ï¸', 'ğŸŒ', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“¹', 'ğŸ”§', 'ğŸ”¨', 'ğŸ› ï¸', 'âš™ï¸', 'ğŸ”©', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ“¡', 'ğŸ“¶', 'ğŸ“Ÿ'] },
      { name: 'Communication', emojis: ['ğŸ’¬', 'ğŸ’­', 'ğŸ—¨ï¸', 'ğŸ“§', 'ğŸ“©', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“¯', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª'] },
      { name: 'Daily Life', emojis: ['ğŸ’©', 'ğŸš½', 'ğŸ§»', 'ğŸ§¼', 'ğŸ§½', 'ğŸ§¹', 'ğŸª£', 'ğŸ§´', 'ğŸ›€', 'ğŸ›Œ', 'ğŸ§¸', 'ğŸª†', 'ğŸ–¼ï¸', 'ğŸª', 'ğŸªŸ', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸ›ï¸', 'ğŸšª', 'ğŸ—ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ”‘', 'ğŸ§³', 'ğŸ’¼', 'ğŸ’', 'ğŸ‘', 'ğŸ‘œ', 'ğŸ‘›', 'ğŸ’°', 'ğŸ’³', 'ğŸ’µ', 'ğŸ¦', 'ğŸ§'] },
      { name: 'Food & Drink', emojis: ['ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸ‡', 'ğŸ“', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ…', 'ğŸ¥‘', 'ğŸ”', 'ğŸ•', 'ğŸŒ­', 'ğŸŸ', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸ¾', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ¥ƒ'] },
      { name: 'Sports & Fun', emojis: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ–ï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸', 'ğŸª', 'ğŸ­', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸª•', 'ğŸ»'] },
      { name: 'Smileys', emojis: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ¤–', 'ğŸ‘¾', 'ğŸ²', 'ğŸ¯', 'ğŸ³', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'] }
    ];

    var emojiBgColors = [
      { name: 'Pink', color: '#E8B4B8' },
      { name: 'Purple', color: '#B4A0E8' },
      { name: 'Blue', color: '#A8C4E8' },
      { name: 'Green', color: '#B8E8C4' },
      { name: 'Yellow', color: '#E8DCA8' },
      { name: 'Orange', color: '#E8C4A8' },
      { name: 'White', color: '#FFFFFF' }
    ];

    var currentEmojiCategory = 0;
    var currentEmojiBgColor = '#E8B4B8';

    function showEmojiPicker() {
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var currentScheme = colorSchemes[currentColorScheme];
      var highlightColor = isDark ? '#8ab4f8' : (currentScheme ? currentScheme.highlight : '#ff8ba7');
      
      // Category tabs - sorted alphabetically
      var sortedCategories = [...emojiCategories].sort(function(a, b) { return a.name.localeCompare(b.name); });
      var html = '<div class="flex gap-1 mb-4 overflow-x-auto pb-2" style="white-space: nowrap;">';
      for (var c = 0; c < sortedCategories.length; c++) {
        var cat = sortedCategories[c];
        var isActive = cat.name === emojiCategories[currentEmojiCategory].name;
        var activeStyle = isActive ? 'background: ' + highlightColor + '; color: white; font-weight: bold;' : 'background: #f0f0f0; color: #333;';
        html += '<button onclick="selectEmojiCategory(\'' + cat.name + '\')" class="px-3 py-1 rounded text-xs transition flex-shrink-0" style="' + activeStyle + '">' + cat.name + '</button>';
      }
      html += '</div>';
      
      // Current category emojis - sorted by Unicode
      var currentCat = emojiCategories[currentEmojiCategory];
      var sortedEmojis = [...currentCat.emojis].sort();
      html += '<div class="flex flex-wrap gap-2 mb-4" style="max-height: 200px; overflow-y: auto;">';
      for (var i = 0; i < sortedEmojis.length; i++) {
        html += '<div onclick="selectAppEmoji(\'' + sortedEmojis[i] + '\')" class="cursor-pointer p-2 text-2xl rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-transform hover:scale-125" title="' + sortedEmojis[i] + '">' + sortedEmojis[i] + '</div>';
      }
      html += '</div>';
      
      // Color picker
      html += '<div class="border-t pt-3">';
      html += '<div class="text-sm font-bold mb-2" style="color: var(--text-secondary);">Background Color</div>';
      html += '<div class="flex gap-2">';
      for (var j = 0; j < emojiBgColors.length; j++) {
        var isSelected = emojiBgColors[j].color === currentEmojiBgColor;
        var borderColor = isSelected ? '#333' : (emojiBgColors[j].color === '#FFFFFF' ? '#ddd' : 'transparent');
        html += '<div onclick="selectEmojiBgColor(\'' + emojiBgColors[j].color + '\', this)" class="cursor-pointer w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 flex-shrink-0" style="background-color: ' + emojiBgColors[j].color + '; border-color: ' + borderColor + ';" title="' + emojiBgColors[j].name + '"></div>';
      }
      html += '</div>';
      html += '</div>';
      
      showModal('Select Emoji', html, [
        { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
        { text: 'Confirm', action: confirmEmojiSelection, class: 'btn-laser' }
      ]);
    }

    function selectEmojiCategory(name) {
      for (var i = 0; i < emojiCategories.length; i++) {
        if (emojiCategories[i].name === name) {
          currentEmojiCategory = i;
          break;
        }
      }
      showEmojiPicker();
    }
    
    function selectEmojiBgColor(color, element) {
      currentEmojiBgColor = color;
      var colorDivs = document.querySelectorAll('[onclick^="selectEmojiBgColor"]');
      for (var i = 0; i < colorDivs.length; i++) {
        colorDivs[i].style.borderColor = 'transparent';
      }
      if (element) {
        element.style.borderColor = '#333';
      }
    }

    function selectAppEmoji(emoji) {
      selectedEmoji = emoji;
      selectedEmojiBg = currentEmojiBgColor;
      // Update preview
      var preview = document.getElementById('iconPreview');
      if (preview) {
        preview.innerHTML = '<span class="text-4xl">' + emoji + '</span>';
        preview.style.backgroundColor = currentEmojiBgColor;
        preview.classList.remove('border', 'border-dashed', 'border-gray-300');
        preview.style.border = '2px solid var(--stroke)';
      }
      // Highlight selected emoji
      var emojiDivs = document.querySelectorAll('[onclick^="selectAppEmoji"]');
      for (var i = 0; i < emojiDivs.length; i++) {
        emojiDivs[i].style.background = 'transparent';
        emojiDivs[i].style.border = 'none';
      }
      // Find and highlight the clicked element (approximate)
      event.target.style.background = 'rgba(0,0,0,0.1)';
      event.target.style.borderRadius = '8px';
    }

    function confirmEmojiSelection() {
      if (selectedEmoji) {
        currentAppIcon = selectedEmoji;
        currentEmojiMode = 'emoji';
        currentAppIconBg = selectedEmojiBg;
      }
      closeModal();
      showAppItemModal(false);
    }

    function showToast(message, type) {
      type = type || 'success';
      var colors = { success: 'bg-blue-600', error: 'bg-red-600' };
      var toast = document.createElement('div');
      toast.className = 'toast px-4 py-2 ' + colors[type] + ' text-white rounded-md text-sm shadow-lg';
      toast.textContent = message;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(function() { toast.remove(); }, 3000);
    }

    // Category Management
    function renderCategoryList() {
      var list = document.getElementById('categoryList');
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var html = '';
      
      // Render folders
      for (var f = 0; f < data.folders.length; f++) {
        var folder = data.folders[f];
        var isExpanded = expandedFolders[folder.id] !== false;
        var isFolderSelected = f === currentFolderIndex;
        var folderIcon = isExpanded ? 'ğŸ“‚' : 'ğŸ“';
        var folderStyle = '';
        var folderTextStyle = '';
        
        if (isFolderSelected) {
          if (isDark) {
            folderStyle = 'background: rgba(138, 180, 248, 0.2);';
            folderTextStyle = 'color: #8ab4f8;';
          } else {
            folderStyle = 'background: var(--highlight);';
            folderTextStyle = 'color: var(--stroke);';
          }
        } else {
          if (isDark) {
            folderTextStyle = 'color: #9ca3af;';
          } else {
            folderTextStyle = 'color: var(--stroke);';
          }
        }
        
        // Folder header
        html += '<div class="folder-item">';
        html += '<div onclick="toggleFolder(' + f + ')" class="flex items-center gap-1 px-2 py-1 rounded cursor-pointer" style="' + folderStyle + '">';
        html += '<span class="folder-icon text-sm">' + folderIcon + '</span>';
        html += '<span onclick="event.stopPropagation(); selectFolder(' + f + ')" class="text-sm font-bold truncate" style="' + folderTextStyle + '">' + folder.name + '</span>';
        html += '<button onclick="event.stopPropagation(); editFolder(' + f + ')" class="ml-auto text-xs opacity-0 folder-edit-btn" style="color: ' + (isDark ? '#9ca3af' : 'var(--stroke)') + ';">âœ</button>';
        html += '<button onclick="event.stopPropagation(); deleteFolder(' + f + ')" class="ml-1 text-xs opacity-0 folder-edit-btn" style="color: ' + (isDark ? '#9ca3af' : 'var(--stroke)') + ';">Ã—</button>';
        html += '</div>';
        
        // Categories in folder
        if (isExpanded && folder.categoryIds) {
          for (var j = 0; j < folder.categoryIds.length; j++) {
            var catId = folder.categoryIds[j];
            var catIndex = data.categories.findIndex(function(c) { return c.id === catId; });
            if (catIndex === -1) continue;
            
            var cat = data.categories[catIndex];
            var icon = cat.name.charAt(0).toUpperCase();
            var catStyle = '';
            var catTextStyle = '';
            var catIconStyle = '';
            
            if (f === currentFolderIndex && catIndex === currentCategoryIndex) {
              if (isDark) {
                catStyle = 'background: #374151; color: white;';
                catTextStyle = 'color: white;';
              } else {
                catStyle = 'background: var(--tertiary);';
                catTextStyle = 'color: var(--stroke);';
              }
            } else {
              if (isDark) {
                catTextStyle = 'color: #9ca3af;';
              } else {
                catTextStyle = 'color: var(--stroke);';
              }
            }
            if (!isDark) {
              catIconStyle = 'background: var(--secondary); border-color: var(--stroke); color: var(--stroke);';
            }
            
            html += '<div onclick="selectCategory(' + catIndex + ', ' + f + ')" class="flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer ml-4" style="' + catStyle + '">';
            html += '<div class="page-icon w-7 h-7 text-xs" style="' + catIconStyle + '">' + icon + '</div>';
            html += '<span class="text-sm font-bold truncate" style="' + catTextStyle + ' font-family: \'Segoe UI Black\', \'Segoe UI\', Arial, sans-serif;">' + cat.name + '</span></div>';
          }
        }
        html += '</div>';
      }
      
      // Add folder button
      html += '<div onclick="showFolderModal(false)" class="flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer toggle-text hover-tertiary mt-2">';
      html += '<span class="text-sm">+</span>';
      html += '<span class="text-sm font-bold" style="color: var(--text-secondary);">New Folder</span>';
      html += '</div>';
      
      list.innerHTML = html;
      
      // Update current category name
      var catName = '';
      if (data.categories && data.categories[currentCategoryIndex]) {
        catName = data.categories[currentCategoryIndex].name;
      }
      var nameEl = document.getElementById('currentCategoryName');
      if (nameEl) nameEl.textContent = catName;
    }
    
    function toggleFolder(index) {
      var folder = data.folders[index];
      expandedFolders[folder.id] = !expandedFolders[folder.id];
      renderCategoryList();
    }
    
    function selectFolder(index) {
      currentFolderIndex = index;
      // Select first category in folder if none selected
      if (data.folders[index] && data.folders[index].categoryIds && data.folders[index].categoryIds.length > 0) {
        var catId = data.folders[index].categoryIds[0];
        var catIndex = data.categories.findIndex(function(c) { return c.id === catId; });
        if (catIndex !== -1) {
          currentCategoryIndex = catIndex;
        }
      }
      currentSubIndex = 0;
      currentTagFilter = null;
      renderCategoryList();
      renderSubTagList();
      renderTagFilter();
      renderContent();
    }
    
    function selectCategory(index, folderIndex) {
      if (index < 0 || !data.categories || index >= data.categories.length) {
        return;
      }
      currentCategoryIndex = index;
      if (folderIndex !== undefined) {
        currentFolderIndex = folderIndex;
      }
      currentSubIndex = 0;
      currentTagFilter = null;
      renderCategoryList();
      renderSubTagList();
      renderTagFilter();
      renderContent();
    }

    // Folder Management
    function showFolderModal(isEdit) {
      isEdit = isEdit || false;
      var folder = isEdit ? data.folders[currentFolderIndex] : null;
      var name = isEdit ? folder.name : '';
      showModal(isEdit ? 'Edit Folder' : 'New Folder',
        '<input type="text" id="folderName" value="' + name + '" placeholder="Folder name" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm">' +
        '<p id="folderError" class="text-red-500 text-xs mt-1 hidden">Please enter a name</p>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
          { text: 'Confirm', action: function() { handleFolderSubmit(isEdit); }, class: 'btn-laser' }
        ]
      );
    }

    function handleFolderSubmit(isEdit) {
      var name = capitalizeWithAcronyms(document.getElementById('folderName').value.trim());
      if (!name) {
        document.getElementById('folderError').classList.remove('hidden');
        return;
      }
      if (isEdit) {
        data.folders[currentFolderIndex].name = name;
      } else {
        data.folders.push({
          id: generateId(),
          name: name,
          categoryIds: []
        });
        currentFolderIndex = data.folders.length - 1;
        expandedFolders[data.folders[currentFolderIndex].id] = true;
      }
      saveData();
      renderCategoryList();
      showToast(isEdit ? 'Folder renamed' : 'Folder created');
      closeModal();
    }

    function editFolder(index) {
      currentFolderIndex = index;
      showFolderModal(true);
    }

    function deleteFolder(index) {
      var name = data.folders[index].name;
      var catCount = data.folders[index].categoryIds ? data.folders[index].categoryIds.length : 0;
      var message = 'Delete folder "' + name + '"?';
      if (catCount > 0) {
        message += ' ' + catCount + ' categories inside will be moved to root.';
      }
      showConfirm(message, function() {
        data.folders.splice(index, 1);
        if (currentFolderIndex >= data.folders.length) {
          currentFolderIndex = data.folders.length > 0 ? data.folders.length - 1 : -1;
        }
        saveData();
        renderCategoryList();
        showToast('Folder deleted');
      });
    }

    function showCategoryModal(isEdit) {
      isEdit = isEdit || false;
      var category = data.categories[currentCategoryIndex];
      var name = isEdit ? category.name : '';
      showModal(isEdit ? 'Edit Page' : 'New Page', 
        '<input type="text" id="categoryName" value="' + name + '" placeholder="Page name" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm">' +
        '<p id="categoryError" class="text-red-500 text-xs mt-1 hidden">Please enter a name</p>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
          { text: 'Confirm', action: function() { handleCategorySubmit(isEdit); }, class: 'btn-laser' }
        ]
      );
    }

    function handleCategorySubmit(isEdit) {
      var name = capitalizeWithAcronyms(document.getElementById('categoryName').value.trim());
      if (!name) {
        document.getElementById('categoryError').classList.remove('hidden');
        return;
      }
      if (isEdit) {
        data.categories[currentCategoryIndex].name = name;
      } else {
        var newCatId = generateId();
        data.categories.push({
          id: newCatId,
          name: name,
          subCompartments: [{ id: generateId(), name: 'Default', items: [] }]
        });
        currentCategoryIndex = data.categories.length - 1;
        // Add to current folder if exists
        if (currentFolderIndex >= 0 && currentFolderIndex < data.folders.length) {
          data.folders[currentFolderIndex].categoryIds.push(newCatId);
        }
        currentSubIndex = 0;
      }
      saveData();
      renderCategoryList();
      renderSubTagList();
      renderContent();
      closeModal();
      showToast(isEdit ? 'Page renamed' : 'Page created');
    }

    function editCategory() { showCategoryModal(true); }

    function deleteCategory() {
      var name = data.categories[currentCategoryIndex].name;
      var catId = data.categories[currentCategoryIndex].id;
      showConfirm('Delete page "' + name + '"? This will delete all content.', function() {
        // Remove category from folders
        for (var i = 0; i < data.folders.length; i++) {
          var idx = data.folders[i].categoryIds.indexOf(catId);
          if (idx !== -1) {
            data.folders[i].categoryIds.splice(idx, 1);
          }
        }
        data.categories.splice(currentCategoryIndex, 1);
        if (data.categories.length === 0) {
          data.categories.push({ id: generateId(), name: 'New Page', subCompartments: [{ id: generateId(), name: 'Default', items: [] }] });
        }
        currentCategoryIndex = Math.min(currentCategoryIndex, data.categories.length - 1);
        currentSubIndex = 0;
        saveData();
        renderCategoryList();
        renderSubTagList();
        renderContent();
        showToast('Page deleted');
      });
    }

    // Sub-compartment Management
    function renderSubTagList() {
      var list = document.getElementById('subTagList');
      if (!data.categories || !data.categories[currentCategoryIndex]) {
        list.innerHTML = '';
        return;
      }
      var category = data.categories[currentCategoryIndex];
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      if (!category) { list.innerHTML = ''; return; }
      
      var html = '';
      for (var i = 0; i < category.subCompartments.length; i++) {
        var sub = category.subCompartments[i];
        var borderColor, bgColor, textColor, hoverBorder;
        if (i === currentSubIndex) {
          if (isDark) {
            borderColor = '#8ab4f8'; bgColor = 'rgba(138, 180, 248, 0.2)'; textColor = '#8ab4f8';
          } else {
            borderColor = 'var(--border-sub)'; bgColor = 'var(--secondary)'; textColor = 'var(--stroke)';
          }
        } else {
          if (isDark) {
            borderColor = '#5f6368'; textColor = '#9ca3af'; hoverBorder = '#8ab4f8';
          } else {
            borderColor = 'var(--border-sub)'; textColor = 'var(--stroke)'; hoverBorder = 'var(--highlight)';
          }
        }
        var btnColor = isDark ? '#9ca3af' : 'var(--stroke)';
        var style = 'border-color: ' + borderColor + '; border-width: 2px;';
        if (i === currentSubIndex) {
          style += 'background: ' + bgColor + ';';
        }
        style += 'color: ' + textColor + ';';
        html += '<div onclick="selectSub(' + i + ')" class="sub-tag inline-flex items-center gap-2 px-4 py-2 rounded-md cursor-pointer border" style="' + style + '">';
        html += '<span class="text-sm font-bold">' + sub.name + '</span>';
        html += '<button onclick="event.stopPropagation(); editSub(' + i + ')" class="text-xs" style="color: ' + btnColor + ';">âœ</button>';
        html += '<button onclick="event.stopPropagation(); deleteSub(' + i + ')" class="text-xs" style="color: ' + btnColor + ';">Ã—</button>';
        html += '</div>';
      }
      list.innerHTML = html;
    }

    function selectSub(index) {
      currentSubIndex = index;
      currentTagFilter = null;
      renderSubTagList();
      renderTagFilter();
      renderContent();
    }

    function renderTagFilter() {
      var list = document.getElementById('tagFilterList');
      var clearBtn = document.getElementById('clearTagFilter');
      var category = data.categories[currentCategoryIndex];
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      if (!category || !category.subCompartments[currentSubIndex]) {
        list.innerHTML = '';
        clearBtn.classList.add('hidden');
        return;
      }
      
      var items = category.subCompartments[currentSubIndex].items;
      var allTags = {};
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (item.tags && item.tags.length > 0) {
          for (var j = 0; j < item.tags.length; j++) {
            allTags[item.tags[j]] = true;
          }
        }
      }
      
      var tags = Object.keys(allTags).sort();
      if (tags.length === 0) {
        list.innerHTML = '<span class="text-xs" style="color: var(--text-secondary);">No tags</span>';
        clearBtn.classList.add('hidden');
        return;
      }
      
      var html = '';
      for (var i = 0; i < tags.length; i++) {
        var tag = tags[i];
        var cls = currentTagFilter === tag 
          ? 'bg-blue-500 text-white border-blue-500' 
          : (isDark ? 'bg-[#303134] text-gray-400 border-gray-600 hover:border-blue-400' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-400');
        html += '<span onclick="filterByTag(\'' + tag.replace(/'/g, "\\'") + '\')" class="tag-chip cursor-pointer ' + cls + '">' + tag + '</span>';
      }
      list.innerHTML = html;
      
      if (currentTagFilter) {
        clearBtn.classList.remove('hidden');
      } else {
        clearBtn.classList.add('hidden');
      }
    }

    function filterByTag(tag) {
      if (currentTagFilter === tag) {
        currentTagFilter = null;
      } else {
        currentTagFilter = tag;
      }
      renderTagFilter();
      renderContent();
    }

    function clearTagFilter() {
      currentTagFilter = null;
      renderTagFilter();
      renderContent();
    }

    function showSubCompartmentModal(isEdit) {
      isEdit = isEdit || false;
      var category = data.categories[currentCategoryIndex];
      var sub = category.subCompartments[currentSubIndex];
      var name = isEdit ? sub.name : '';
      showModal(isEdit ? 'Rename Group' : 'New Group',
        '<input type="text" id="subName" value="' + name + '" placeholder="Group name" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm">' +
        '<p id="subError" class="text-red-500 text-xs mt-1 hidden">Please enter a name</p>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
          { text: 'Confirm', action: function() { handleSubSubmit(isEdit); }, class: 'btn-laser' }
        ]
      );
    }

    function handleSubSubmit(isEdit) {
      var name = capitalizeWithAcronyms(document.getElementById('subName').value.trim());
      if (!name) {
        document.getElementById('subError').classList.remove('hidden');
        return;
      }
      var category = data.categories[currentCategoryIndex];
      if (isEdit) {
        category.subCompartments[currentSubIndex].name = name;
      } else {
        category.subCompartments.push({ id: generateId(), name: name, items: [] });
        currentSubIndex = category.subCompartments.length - 1;
      }
      saveData();
      renderSubTagList();
      renderContent();
      closeModal();
      showToast(isEdit ? 'Group renamed' : 'Group created');
    }

    function editSub(index) {
      currentSubIndex = index;
      showSubCompartmentModal(true);
    }

    function deleteSub(index) {
      var name = data.categories[currentCategoryIndex].subCompartments[index].name;
      showConfirm('Delete group "' + name + '"?', function() {
        data.categories[currentCategoryIndex].subCompartments.splice(index, 1);
        if (data.categories[currentCategoryIndex].subCompartments.length === 0) {
          data.categories[currentCategoryIndex].subCompartments.push({ id: generateId(), name: 'Default', items: [] });
        }
        currentSubIndex = Math.min(currentSubIndex, data.categories[currentCategoryIndex].subCompartments.length - 1);
        saveData();
        renderSubTagList();
        renderContent();
        showToast('Group deleted');
      });
    }

    // Search Functions
    function handleGlobalSearch(value) {
      globalSearchQuery = value.toLowerCase();
      renderContent();
    }

    function handleLocalSearch(value) {
      localSearchQuery = value.toLowerCase();
      renderContent();
    }

    function clearGlobalSearch() {
      document.getElementById('globalSearch').value = '';
      globalSearchQuery = '';
      renderContent();
    }

    function clearLocalSearch() {
      document.getElementById('localSearch').value = '';
      localSearchQuery = '';
      renderContent();
    }

    function sortItems(items, method) {
      var sorted = items.slice();
      if (method === 'name-asc') {
        sorted.sort(function(a, b) { return a.name.localeCompare(b.name); });
      } else if (method === 'name-desc') {
        sorted.sort(function(a, b) { return b.name.localeCompare(a.name); });
      } else if (method === 'created') {
        sorted.sort(function(a, b) { return (b.createdAt || 0) - (a.createdAt || 0); });
      }
      return sorted;
    }

    function changeSort(method) {
      currentSortMethod = method;
      updateSortButtons();
      renderContent();
    }

    function updateSortButtons() {
      var btns = document.querySelectorAll('.sort-btn');
      btns.forEach(function(btn) {
        if (btn.dataset.sort === currentSortMethod) {
          btn.classList.add('bg-blue-500', 'text-white');
          btn.classList.remove('bg-gray-200', 'text-gray-700');
        } else {
          btn.classList.remove('bg-blue-500', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        }
      });
    }

    function matchesSearch(item, query) {
      if (!query) return true;
      var nameMatch = item.name && item.name.toLowerCase().includes(query);
      var notesMatch = false;
      if (item.notes && item.notes.length > 0) {
        for (var i = 0; i < item.notes.length; i++) {
          if (item.notes[i].toLowerCase().includes(query)) {
            notesMatch = true;
            break;
          }
        }
      }
      return nameMatch || notesMatch;
    }

    // Content Management
    function renderContent() {
      var grid = document.getElementById('contentGrid');
      if (!data.categories || !data.categories[currentCategoryIndex]) {
        grid.innerHTML = '';
        return;
      }
      var category = data.categories[currentCategoryIndex];
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      if (!category || !category.subCompartments || !category.subCompartments[currentSubIndex]) {
        grid.innerHTML = '';
        return;
      }
      var items = category.subCompartments[currentSubIndex].items;
      
      // Filter by tag if selected
      var filteredItems = items;
      if (currentTagFilter) {
        filteredItems = [];
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (item.tags && item.tags.indexOf(currentTagFilter) !== -1) {
            filteredItems.push(item);
          }
        }
      }
      
      // Apply search filters
      if (globalSearchQuery || localSearchQuery) {
        var searchResults = [];
        var seenIds = {}; // For deduplication
        if (globalSearchQuery) {
          // Global search: search all categories
          for (var catIdx = 0; catIdx < data.categories.length; catIdx++) {
            var cat = data.categories[catIdx];
            if (cat.subCompartments) {
              for (var subIdx = 0; subIdx < cat.subCompartments.length; subIdx++) {
                var subItems = cat.subCompartments[subIdx].items;
                for (var itemIdx = 0; itemIdx < subItems.length; itemIdx++) {
                  var item = subItems[itemIdx];
                  if (matchesSearch(item, globalSearchQuery) && !seenIds[item.id]) {
                    seenIds[item.id] = true;
                    searchResults.push(item);
                  }
                }
              }
            }
          }
        } else if (localSearchQuery) {
          // Local search: search current category only
          for (var i = 0; i < filteredItems.length; i++) {
            if (matchesSearch(filteredItems[i], localSearchQuery)) {
              searchResults.push(filteredItems[i]);
            }
          }
        }
        filteredItems = searchResults;
      }
      
      if (!globalSearchQuery && !localSearchQuery) {
        filteredItems = sortItems(filteredItems, currentSortMethod);
      }
      
      if (filteredItems.length === 0) {
        var noResultsMsg = (globalSearchQuery || localSearchQuery) ? 'No results found' : 'No content yet, click buttons above to add';
        grid.innerHTML = '<p class="text-sm" style="color: var(--text-secondary);">' + noResultsMsg + '</p>';
        return;
      }
      
      // Separate web and app items
      var webItems = [];
      var appItems = [];
      for (var i = 0; i < filteredItems.length; i++) {
        if (filteredItems[i].type === 'web') {
          webItems.push(filteredItems[i]);
        } else {
          appItems.push(filteredItems[i]);
        }
      }
      
      var html = '';
      var cardBg = isDark ? '#303134' : '#ffffff';
      var cardBorder = isDark ? '#5f6368' : '#bdbdbd';
      var textColor = isDark ? '#e8eaed' : '#5a4e50';
      var btnColor = isDark ? '#9aa0a6' : '#666666';
      var linkColor = isDark ? '#8ab4f8' : 'var(--highlight, #1a73e8)';
      
      // Render Web section header
      if (webItems.length > 0) {
        html += '<div class="w-full mb-4">';
        html += '<div class="flex items-center mb-3">';
        html += '<h3 class="text-sm font-bold" style="color: var(--text-primary);">Web</h3>';
        html += '</div>';
        html += '<div class="flex flex-wrap gap-2.5">';
        
        for (var i = 0; i < webItems.length; i++) {
          var item = webItems[i];
          var originalIndex = items.indexOf(item);
          var displayName = item.name.charAt(0).toUpperCase() + item.name.slice(1);
          var tagsHtml = '';
          var notesHtml = '';
          
          if (item.tags && item.tags.length > 0) {
            tagsHtml = '<div class="flex flex-wrap gap-1 mt-2">' + item.tags.map(function(t) { 
              var cls = currentTagFilter === t ? 'bg-blue-500 text-white border-blue-500' : '';
              return '<span onclick="filterByTag(\'' + t.replace(/'/g, "\\'") + '\')" class="tag-chip cursor-pointer ' + cls + '">' + t + '</span>'; 
            }).join('') + '</div>';
          }
          
          if (item.notes && item.notes.length > 0) {
            notesHtml = '<div class="flex flex-wrap gap-1 mt-2">' + item.notes.map(function(n, ni) { 
              return '<span class="note-tag">' + n + '<button onclick="removeNote(' + originalIndex + ',' + ni + ')">Ã—</button></span>'; 
            }).join('') + '</div>';
          }
          
          html += '<div class="content-card rounded-xl p-4 border-[3px] w-[calc(33.333%-7px)] min-w-[200px]" style="background: ' + cardBg + '; border-color: ' + cardBorder + ';">';
          html += '<div class="flex items-center justify-between mb-2">';
          html += '<span class="text-sm font-bold line-clamp-2" style="color: ' + textColor + '; font-family: \'Segoe UI Black\', \'Segoe UI\', Arial, sans-serif;">' + displayName + '</span>';
          html += '<div class="flex gap-1">';
          html += '<button onclick="copyItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Copy</button>';
          html += '<button onclick="moveItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Move</button>';
          html += '<button onclick="editWebItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Edit</button>';
          html += '<button onclick="deleteItem(' + originalIndex + ')" class="btn-laser-danger px-2 py-1 rounded text-xs font-medium transition">Delete</button>';
          html += '</div></div>';
          html += '<a href="' + item.url + '" target="_blank" class="hover:underline text-xs truncate block" style="color: ' + linkColor + ';">' + item.url + '</a>';
          html += tagsHtml + notesHtml;
          html += '</div>';
        }
        html += '</div></div>';
      }
      
      // Divider
      if (webItems.length > 0 && appItems.length > 0) {
        var dividerColor = isDark ? 'rgba(138, 180, 248, 0.4)' : '#cccccc';
        html += '<div class="w-full border-t border-dashed my-4" style="border-color: ' + dividerColor + ';"></div>';
      }
      
      // Render App section header
      if (appItems.length > 0) {
        html += '<div class="w-full">';
        html += '<div class="flex items-center mb-3">';
        html += '<h3 class="text-sm font-bold" style="color: var(--text-primary);">App</h3>';
        html += '</div>';
        html += '<div class="flex flex-wrap gap-2.5">';
        
        for (var i = 0; i < appItems.length; i++) {
          var item = appItems[i];
          var originalIndex = items.indexOf(item);
          var displayName = item.name.charAt(0).toUpperCase() + item.name.slice(1);
          var tagsHtml = '';
          var notesHtml = '';
          
          if (item.tags && item.tags.length > 0) {
            tagsHtml = '<div class="flex flex-wrap gap-1 mt-2">' + item.tags.map(function(t) { 
              var cls = currentTagFilter === t ? 'bg-blue-500 text-white border-blue-500' : '';
              return '<span onclick="filterByTag(\'' + t.replace(/'/g, "\\'") + '\')" class="tag-chip cursor-pointer ' + cls + '">' + t + '</span>'; 
            }).join('') + '</div>';
          }
          
          if (item.notes && item.notes.length > 0) {
            notesHtml = '<div class="flex flex-wrap gap-1 mt-2">' + item.notes.map(function(n, ni) { 
              return '<span class="note-tag">' + n + '<button onclick="removeNote(' + originalIndex + ',' + ni + ')">Ã—</button></span>'; 
            }).join('') + '</div>';
          }
          
          html += '<div class="content-card rounded-xl p-4 border-[3px] w-[calc(33.333%-7px)] min-w-[200px]" style="background: ' + cardBg + '; border-color: ' + cardBorder + ';">';
          html += '<div class="flex items-center gap-3 mb-2">';
          // Check if icon is an emoji or image
          if (item.icon && appEmojis.indexOf(item.icon) !== -1) {
            var emojiBg = item.iconBg || '#E8B4B8';
            html += '<div class="w-16 h-16 rounded-xl flex items-center justify-center text-4xl" style="background-color: ' + emojiBg + '; border: 2px solid var(--stroke);">' + item.icon + '</div>';
          } else {
            html += '<img src="' + item.icon + '" class="w-16 h-16 object-cover rounded-xl" alt="' + item.name + '">';
          }
          html += '<span class="text-sm font-bold line-clamp-2" style="color: ' + textColor + '; font-family: \'Segoe UI Black\', \'Segoe UI\', Arial, sans-serif;">' + displayName + '</span>';
          html += '</div>';
          html += '<div class="flex justify-end gap-1 mt-2">';
          html += '<button onclick="copyItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Copy</button>';
          html += '<button onclick="moveItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Move</button>';
          html += '<button onclick="editAppItem(' + originalIndex + ')" class="btn-laser px-2 py-1 rounded text-xs font-medium transition">Edit</button>';
          html += '<button onclick="deleteItem(' + originalIndex + ')" class="btn-laser-danger px-2 py-1 rounded text-xs font-medium transition">Delete</button>';
          html += '</div>';
          html += tagsHtml + notesHtml;
          html += '</div>';
        }
        html += '</div></div>';
      }
      
      grid.innerHTML = html;
    }

    function removeNote(itemIndex, noteIndex) {
      var category = data.categories[currentCategoryIndex];
      var items = category.subCompartments[currentSubIndex].items;
      var item = items[itemIndex];
      if (item && item.notes) {
        item.notes.splice(noteIndex, 1);
        saveData();
        renderContent();
        showToast('Note removed');
      }
    }

    // Web Item
    var editItemIndex = -1;
    var currentAppIcon = '';
    var currentAppIconBg = '';

    function showWebItemModal(isEdit) {
      isEdit = isEdit || false;
      var category = data.categories[currentCategoryIndex];
      var items = category.subCompartments[currentSubIndex].items;
      var name = '', url = '', tags = [], notes = [], editIndex = -1;
      
      if (isEdit) {
        var item = items[editItemIndex];
        if (item) {
          name = item.name;
          url = item.url;
          tags = item.tags || [];
          notes = item.notes || [];
          editIndex = editItemIndex;
        }
      }

      showModal(isEdit ? 'Edit Web' : 'Add Web',
        '<div class="space-y-4">' +
        '<div><label class="block text-sm text-gray-400 mb-1">Name <span class="text-red-500">*</span></label>' +
        '<input type="text" id="webName" value="' + name + '" placeholder="Enter name" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">URL <span class="text-red-500">*</span></label>' +
        '<input type="text" id="webUrl" value="' + url + '" placeholder="example.com" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<div class="flex items-center gap-2">' +
        '<input type="checkbox" id="autoHttps" checked class="w-4 h-4">' +
        '<label for="autoHttps" class="text-sm text-gray-400">Auto add https://</label>' +
        '</div></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">Tags (separated by comma)</label>' +
        '<input type="text" id="webTags" value="' + (tags ? tags.join(', ') : '') + '" placeholder="e.g. Free, High quality" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">Notes (separated by comma)</label>' +
        '<input type="text" id="webNotes" value="' + (notes ? notes.join(', ') : '') + '" placeholder="e.g. Provides photos, Commercial use" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<p id="webError" class="text-red-500 text-sm hidden">Please enter a valid URL</p></div>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
          { text: isEdit ? 'Save' : 'Add', action: function() { handleWebSubmit(isEdit, editIndex); }, class: 'btn-laser' }
        ]
      );
    }

    function handleWebSubmit(isEdit, editIndex) {
      var name = capitalizeWithAcronyms(document.getElementById('webName').value.trim());
      var url = document.getElementById('webUrl').value.trim();
      var tagsInput = document.getElementById('webTags').value.trim();
      var notesInput = document.getElementById('webNotes').value.trim();
      var tags = tagsInput ? tagsInput.split(',').map(function(t) { return capitalizeWord(t.trim()); }).filter(function(t) { return t; }) : [];
      var notes = notesInput ? notesInput.split(',').map(function(n) { return capitalizeWord(n.trim()); }).filter(function(n) { return n; }) : [];
      var errorEl = document.getElementById('webError');
      
      if (!name || !url) {
        if (!url) {
          errorEl.textContent = 'Please enter a URL';
          errorEl.classList.remove('hidden');
          return;
        }
      }
      
      if (url && !url.match(/^https?:\/\//)) {
        var autoHttps = document.getElementById('autoHttps').checked;
        if (autoHttps) {
          url = 'https://' + url;
        }
      }
      
      if (!url.match(/^https?:\/\/.+/)) {
        errorEl.textContent = 'Please enter a valid URL';
        errorEl.classList.remove('hidden');
        return;
      }
      
      var category = data.categories[currentCategoryIndex];
      var items = category.subCompartments[currentSubIndex].items;
      
      if (isEdit && editIndex >= 0) {
        items[editIndex].name = name;
        items[editIndex].url = url;
        items[editIndex].tags = tags;
        items[editIndex].notes = notes;
      } else {
        items.push({ id: generateId(), type: 'web', name: name, url: url, tags: tags, notes: notes, createdAt: Date.now() });
      }
      
      saveData();
      renderContent();
      closeModal();
      showToast(isEdit ? 'Updated' : 'Added');
    }

    function editWebItem(index) {
      editItemIndex = index;
      showWebItemModal(true);
    }

    // App Item
    var editAppIndex = -1;

    function showAppItemModal(isEdit) {
      isEdit = isEdit || false;
      var category = data.categories[currentCategoryIndex];
      var items = category.subCompartments[currentSubIndex].items;
      var name = '', icon = currentAppIcon || '', tags = [], notes = [], editIndex = -1, iconBg = currentAppIconBg || '#E8B4B8';
      
      if (isEdit) {
        var item = items[editAppIndex];
        if (item) {
          name = item.name;
          icon = item.icon;
          tags = item.tags || [];
          notes = item.notes || [];
          editIndex = editAppIndex;
          iconBg = item.iconBg || '#E8B4B8';
        }
      }

      var isEmojiMode = icon && appEmojis.indexOf(icon) !== -1;
      var previewStyle = '';
      if (isEmojiMode) {
        previewStyle = 'background-color: ' + iconBg + '; border: 2px solid var(--stroke);';
      }
      var previewContent = '';
      if (isEmojiMode) {
        previewContent = '<span class="text-4xl">' + icon + '</span>';
      } else if (icon) {
        previewContent = '<img src="' + icon + '" class="w-full h-full object-cover">';
      } else {
        previewContent = '<span class="text-gray-400 text-xs">Preview</span>';
      }
      
      showModal(isEdit ? 'Edit App' : 'Add App',
        '<div class="space-y-4">' +
        '<div><label class="block text-sm text-gray-400 mb-1">App Name <span class="text-red-500">*</span></label>' +
        '<input type="text" id="appName" value="' + name + '" placeholder="Enter app name" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">Icon <span class="text-red-500">*</span></label>' +
        '<div class="flex items-center gap-4 mb-2">' +
        '<div id="iconPreview" class="w-16 h-16 rounded-xl flex items-center justify-center overflow-hidden ' + (icon ? '' : 'border border-dashed border-gray-300') + '" style="' + previewStyle + '">' +
        previewContent +
        '</div>' +
        '<div class="flex gap-2">' +
        '<label class="btn-laser px-3 py-2 rounded text-sm font-medium transition cursor-pointer">' +
        'ğŸ“ Choose File' +
        '<input type="file" id="appIcon" accept="image/jpeg,image/png" onchange="handleIconUpload(event)" class="hidden">' +
        '</label>' +
        '<button onclick="showEmojiPicker()" class="btn-laser px-3 py-2 rounded text-sm font-medium transition">ğŸ˜Š Choose Emoji</button>' +
        '</div></div></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">Tags (separated by comma)</label>' +
        '<input type="text" id="appTags" value="' + (tags ? tags.join(', ') : '') + '" placeholder="e.g. Free, iOS" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<div><label class="block text-sm text-gray-400 mb-1">Notes (separated by comma)</label>' +
        '<input type="text" id="appNotes" value="' + (notes ? notes.join(', ') : '') + '" placeholder="e.g. Cloud sync, Offline mode" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm"></div>' +
        '<p id="appError" class="text-red-500 text-sm hidden"></p></div>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-600 hover:bg-gray-500 text-gray-200' },
          { text: isEdit ? 'Save' : 'Add', action: function() { handleAppSubmit(isEdit, editIndex); }, class: 'btn-laser' }
        ]
      );
      
      if (isEdit && icon) {
        currentAppIcon = icon;
        currentAppIconBg = iconBg;
      }
    }

    function handleIconUpload(event) {
      var file = event.target.files[0];
      if (!file) return;
      
      if (!file.type.match(/^image\/(jpeg|png)$/)) {
        showToast('Please upload jpg or png', 'error');
        return;
      }
      
      if (file.size > 2 * 1024 * 1024) {
        showToast('Image must be under 2MB', 'error');
        return;
      }
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
          var canvas = document.createElement('canvas');
          var size = 64;
          canvas.width = size;
          canvas.height = size;
          var ctx = canvas.getContext('2d');
          
          var minDim = Math.min(img.width, img.height);
          var sx = (img.width - minDim) / 2;
          var sy = (img.height - minDim) / 2;
          
          ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
          
          currentAppIcon = canvas.toDataURL('image/png');
          
          document.getElementById('iconPreview').innerHTML = '<img src="' + currentAppIcon + '" class="w-full h-full object-cover">';
          document.getElementById('iconPreview').classList.remove('border-dashed', 'border-gray-300');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function handleAppSubmit(isEdit, editIndex) {
      var name = capitalizeWithAcronyms(document.getElementById('appName').value.trim());
      var tagsInput = document.getElementById('appTags').value.trim();
      var notesInput = document.getElementById('appNotes').value.trim();
      var tags = tagsInput ? tagsInput.split(',').map(function(t) { return capitalizeWord(t.trim()); }).filter(function(t) { return t; }) : [];
      var notes = notesInput ? notesInput.split(',').map(function(n) { return capitalizeWord(n.trim()); }).filter(function(n) { return n; }) : [];
      var errorEl = document.getElementById('appError');
      
      if (!name) {
        errorEl.textContent = 'Please enter app name';
        errorEl.classList.remove('hidden');
        return;
      }
      
      if (!currentAppIcon) {
        errorEl.textContent = 'Please upload icon';
        errorEl.classList.remove('hidden');
        return;
      }
      
      var category = data.categories[currentCategoryIndex];
      var items = category.subCompartments[currentSubIndex].items;
      
      if (isEdit && editIndex >= 0) {
        items[editIndex].name = name;
        items[editIndex].icon = currentAppIcon;
        items[editIndex].iconBg = currentAppIconBg || items[editIndex].iconBg;
        items[editIndex].tags = tags;
        items[editIndex].notes = notes;
      } else {
        items.push({ id: generateId(), type: 'app', name: name, icon: currentAppIcon, iconBg: currentAppIconBg, tags: tags, notes: notes, createdAt: Date.now() });
      }
      
      currentAppIcon = '';
      currentAppIconBg = '';
      saveData();
      renderContent();
      closeModal();
      showToast(isEdit ? 'Updated' : 'Added');
    }

    function editAppItem(index) {
      editAppIndex = index;
      showAppItemModal(true);
    }

    function deleteItem(index) {
      var category = data.categories[currentCategoryIndex];
      var item = category.subCompartments[currentSubIndex].items[index];
      var type = item.type === 'web' ? 'Web' : 'App';
      showConfirm('Delete this ' + type + '?', function() {
        category.subCompartments[currentSubIndex].items.splice(index, 1);
        saveData();
        renderContent();
        showToast('Deleted');
      });
    }

    function copyItem(index) {
      var category = data.categories[currentCategoryIndex];
      var item = category.subCompartments[currentSubIndex].items[index];
      copyMoveItem = JSON.parse(JSON.stringify(item));
      copyMoveMode = 'copy';
      copyMoveSourceIndex = -1;
      showCopyMoveModal();
    }

    function moveItem(index) {
      var category = data.categories[currentCategoryIndex];
      var item = category.subCompartments[currentSubIndex].items[index];
      copyMoveItem = JSON.parse(JSON.stringify(item));
      copyMoveMode = 'move';
      copyMoveSourceIndex = index; // ä¿å­˜åŸå§‹ç´¢å¼•ç”¨äºåˆ é™¤
      showCopyMoveModal();
    }

    function showCopyMoveModal() {
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var textColor = isDark ? '#ffffff' : '#33272a';
      var textMainColor = isDark ? '#ffffff' : '#33272a';
      var optionsHtml = '';
      
      optionsHtml += '<div class="flex gap-2 mb-4">';
      optionsHtml += '<button onclick="showNewFolderInCopyMove()" class="btn-laser px-3 py-2 rounded text-sm flex-1">+ æ–°å»ºæ–‡ä»¶å¤¹</button>';
      optionsHtml += '<button onclick="showNewGroupInCopyMove()" class="btn-laser px-3 py-2 rounded text-sm flex-1">+ æ–°å»ºåˆ†ç»„</button>';
      optionsHtml += '</div>';
      
      for (var i = 0; i < data.categories.length; i++) {
        var cat = data.categories[i];
        optionsHtml += '<div class="font-bold mb-2" style="color: ' + textColor + ';">' + cat.name + '</div>';
        for (var j = 0; j < cat.subCompartments.length; j++) {
          var sub = cat.subCompartments[j];
          var isCurrent = i === currentCategoryIndex && j === currentSubIndex;
          optionsHtml += '<div onclick="handleCopyMove(' + i + ',' + j + ')" class="px-3 py-2 rounded cursor-pointer mb-1 ' + (isCurrent ? 'bg-gray-200' : '') + '" style="' + (isCurrent ? 'background: var(--tertiary);' : 'background: var(--secondary);') + '">';
          optionsHtml += '<span style="color: ' + textMainColor + ';">' + sub.name + '</span>';
          optionsHtml += '</div>';
        }
      }
      var modeText = copyMoveMode === 'copy' ? 'Copy' : 'Move';
      showModal(modeText + ' to...', 
        '<div class="max-h-60 overflow-y-auto">' + optionsHtml + '</div>',
        [
          { text: 'Cancel', action: closeModal, class: 'bg-gray-200 hover:bg-gray-300' }
        ]
      );
    }
    
    function showNewFolderInCopyMove() {
      showModal('æ–°å»ºæ–‡ä»¶å¤¹',
        '<input type="text" id="newFolderName" placeholder="æ–‡ä»¶å¤¹åç§°" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm">' +
        '<p id="newFolderError" class="text-red-500 text-xs mt-1 hidden">è¯·è¾“å…¥åç§°</p>',
        [
          { text: 'å–æ¶ˆ', action: closeModal, class: 'bg-gray-200 hover:bg-gray-300' },
          { text: 'åˆ›å»º', action: function() {
            var name = capitalizeWithAcronyms(document.getElementById('newFolderName').value.trim());
            if (!name) {
              document.getElementById('newFolderError').classList.remove('hidden');
              return;
            }
            var newCatId = generateId();
            data.categories.push({
              id: newCatId,
              name: name,
              subCompartments: [{ id: generateId(), name: 'Default', items: [] }]
            });
            var newCatIndex = data.categories.length - 1;
            saveData();
            closeModal();
            showCopyMoveModal();
          }, class: 'btn-laser' }
        ]
      );
    }
    
    function showNewGroupInCopyMove() {
      showModal('æ–°å»ºåˆ†ç»„',
        '<input type="text" id="newGroupName" placeholder="åˆ†ç»„åç§°" class="modal-input w-full px-3 py-2 border rounded-md focus:outline-none focus:border-primary text-sm">' +
        '<p id="newGroupError" class="text-red-500 text-xs mt-1 hidden">è¯·è¾“å…¥åç§°</p>',
        [
          { text: 'å–æ¶ˆ', action: closeModal, class: 'bg-gray-200 hover:bg-gray-300' },
          { text: 'åˆ›å»º', action: function() {
            var name = capitalizeWithAcronyms(document.getElementById('newGroupName').value.trim());
            if (!name) {
              document.getElementById('newGroupError').classList.remove('hidden');
              return;
            }
            data.categories[currentCategoryIndex].subCompartments.push({ id: generateId(), name: name, items: [] });
            saveData();
            closeModal();
            showCopyMoveModal();
          }, class: 'btn-laser' }
        ]
      );
    }

    function handleCopyMove(targetCatIndex, targetSubIndex) {
      var targetCategory = data.categories[targetCatIndex];
      var targetSub = targetCategory.subCompartments[targetSubIndex];
      
      var existingIndex = -1;
      var itemName = copyMoveItem.name.toLowerCase();
      for (var i = 0; i < targetSub.items.length; i++) {
        if (targetSub.items[i].name.toLowerCase() === itemName) {
          existingIndex = i;
          break;
        }
      }
      
      if (existingIndex !== -1) {
        closeModal();
        showModal('å‘ç°åŒåæ–‡ä»¶',
          '<p class="text-sm mb-4" style="color: var(--text-secondary);">ç›®æ ‡ä½ç½®å·²å­˜åœ¨ "' + targetSub.items[existingIndex].name + '"ï¼Œè¯·é€‰æ‹©æ“ä½œï¼š</p>',
          [
            { text: 'è·³è¿‡', action: function() { 
              copyMoveItem = null; 
              copyMoveMode = '';
              copyMoveSourceIndex = -1;
              closeModal(); 
            }, class: 'bg-gray-200 hover:bg-gray-300' },
            { text: 'ä¿ç•™ä¸¤è€…', action: function() { 
              executeCopyMove(targetCategory, targetSub, targetCatIndex, targetSubIndex); 
            }, class: 'bg-yellow-500 hover:bg-yellow-600 text-white' },
            { text: 'æ›¿æ¢', action: function() { 
              targetSub.items.splice(existingIndex, 1);
              executeCopyMove(targetCategory, targetSub, targetCatIndex, targetSubIndex); 
            }, class: 'btn-laser' }
          ]
        );
      } else {
        executeCopyMove(targetCategory, targetSub, targetCatIndex, targetSubIndex);
      }
    }
    
    function executeCopyMove(targetCategory, targetSub, targetCatIndex, targetSubIndex) {
      if (copyMoveMode === 'copy') {
        copyMoveItem.id = generateId();
        copyMoveItem.createdAt = Date.now();
      }
      
      targetSub.items.push(copyMoveItem);
      
      if (copyMoveMode === 'move') {
        var sourceCategory = data.categories[currentCategoryIndex];
        sourceCategory.subCompartments[currentSubIndex].items.splice(copyMoveSourceIndex, 1);
        copyMoveSourceIndex = -1;
      }
      
      saveData();
      closeModal();
      renderContent();
      renderTagFilter();
      showToast(copyMoveMode === 'copy' ? 'å·²å¤åˆ¶' : 'å·²ç§»åŠ¨');
      copyMoveItem = null;
      copyMoveMode = '';
    }

    // Modal Functions
    function showModal(title, content, actions) {
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var modal = document.getElementById('modalOverlay').querySelector('div');
      modal.style.background = isDark ? '#303134' : '#ffffff';
      modal.style.borderColor = isDark ? '#5f6368' : '#dadce0';
      var header = modal.querySelector('.border-b');
      header.style.borderColor = isDark ? '#5f6368' : '#dadce0';
      var titleEl = document.getElementById('modalTitle');
      titleEl.style.color = isDark ? '#e8eaed' : '#202124';
      var actionsDiv = document.getElementById('modalActions');
      actionsDiv.style.background = isDark ? '#292a2d' : '#f8f9fa';
      
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalContent').innerHTML = content;
      actionsDiv.innerHTML = '';
      for (var i = 0; i < actions.length; i++) {
        var a = actions[i];
        var btn = document.createElement('button');
        btn.className = 'px-4 py-2 ' + a.class + ' rounded text-sm font-medium transition';
        if (a.class.indexOf('btn-laser') === -1) {
          btn.style.background = isDark ? '#5f6368' : '#f1f3f4';
          btn.style.color = isDark ? '#e8eaed' : '#202124';
          btn.style.border = 'none';
        }
        btn.textContent = a.text;
        btn.onclick = a.action;
        actionsDiv.appendChild(btn);
      }
      // Add Enter key support for input fields
      var inputs = document.getElementById('modalContent').querySelectorAll('input');
      var confirmAction = actions.length > 0 ? actions[actions.length - 1].action : null;
      for (var j = 0; j < inputs.length; j++) {
        inputs[j].onkeydown = function(e) {
          if (e.key === 'Enter' && confirmAction) {
            e.preventDefault();
            confirmAction();
          }
        };
      }
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }

    function showConfirm(message, onConfirm) {
      var isDark = document.body.getAttribute('data-theme') === 'dark';
      var modal = document.getElementById('confirmOverlay').querySelector('div');
      modal.style.background = isDark ? '#303134' : '#ffffff';
      modal.style.borderColor = isDark ? '#5f6368' : '#dadce0';
      var header = modal.querySelector('.border-b');
      header.style.borderColor = isDark ? '#5f6368' : '#dadce0';
      var titleEl = modal.querySelector('h3');
      titleEl.style.color = isDark ? '#e8eaed' : '#202124';
      var msgEl = document.getElementById('confirmMessage');
      msgEl.style.color = isDark ? '#9aa0a6' : '#5f6368';
      var actionsDiv = modal.querySelector('.bg-\\[\\#292a2d\\]');
      if (actionsDiv) {
        actionsDiv.style.background = isDark ? '#292a2d' : '#f8f9fa';
      }
      var cancelBtn = actionsDiv ? actionsDiv.querySelector('button') : null;
      if (cancelBtn) {
        cancelBtn.style.background = isDark ? '#5f6368' : '#f1f3f4';
        cancelBtn.style.color = isDark ? '#e8eaed' : '#202124';
      }
      
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmBtn').onclick = function() {
        closeConfirm();
        onConfirm();
      };
      document.getElementById('confirmOverlay').classList.remove('hidden');
    }

    function closeConfirm() {
      document.getElementById('confirmOverlay').classList.add('hidden');
    }

    // Import/Export
    function exportData() {
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      var date = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = 'toolbox-backup-' + date + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Exported');
    }

    function importData() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      var file = event.target.files[0];
      if (!file) return;
      
      showConfirm('Import will overwrite existing data. Continue?', function() {
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var imported = JSON.parse(e.target.result);
            if (!imported.categories || !Array.isArray(imported.categories)) {
              throw new Error('Invalid data format');
            }
            // Handle old format without folders
            if (!imported.folders || !Array.isArray(imported.folders)) {
              var categoryIds = imported.categories.map(function(cat) { return cat.id; });
              imported.folders = [{ id: generateId(), name: 'Default', categoryIds: categoryIds }];
            }
            data = imported;
            // Reset states
            currentFolderIndex = data.folders.length > 0 ? 0 : -1;
            currentCategoryIndex = 0;
            currentSubIndex = 0;
            expandedFolders = {};
            data.folders.forEach(function(folder) {
              expandedFolders[folder.id] = true;
            });
            saveData();
            renderCategoryList();
            renderSubTagList();
            renderContent();
            showToast('Imported successfully');
          } catch (err) {
            showToast('Import failed: ' + err.message, 'error');
          }
        };
        reader.readAsText(file);
      });
      event.target.value = '';
    }

    // Initialize
    init();
  </script>
</body>
</html>
